
parameters:
  - u:		users-guide
  - tagfile:	html-css
  - dir:	data
  - htmlfiles:	[ users-guide.html, faq.html, examples.html ]
  - original_docdir:  ../../../rbtenjin/trunk/doc
  - lang:       perl


materials:
  - $(original_docdir)/users-guide.eruby
  - $(original_docdir)/faq.eruby


recipes:

  - product:	:all
    ingreds:	[ :doc, :test ]

  - product:	:doc
    ingreds:	[ $(htmlfiles) ]

  - product:	*.html
    ingreds:	[ $(1).txt ]
    byprods:	[ $(1).toc.html ]
    method*: |
	k_sys("kwaser -t $(tagfile) -T $ingred > $byprod");
	k_sys("kwaser -t $(tagfile)    $ingred > $product");

  - product:	*.txt
    ingreds:	[ $(1).eruby ]
    method*: |
	k_sys("erubis -E PercentLine -p '\\[% %\\]' -c '@lang=%q|$(lang)|' $ingred > $product");
	$name = preg_replace('/-/', '_', '$(1)');
	$testdir = '../test';
	if (! is_dir($testdir)) {
	    throw "testdir not found.";
	}
	$datadir = "$testdir/$(dir)/$name";
	if (! is_dir($datadir)) {
	    k_mkdir($datadir);
	}
	k_delete("$datadir/*");
	k_sys("retrieve -Fd $datadir $product");
	#ln_s "#{testdir}/$(dir)", "." unless test(?e, '$(dir)')
	foreach (kook_glob("$datadir/*.result2") as $filename) {
	    $content = file_get_contents($filename);
	    unlink($filename);
	    $contents = preg_split('/^\$ /m', $content);
	    $i = 0;
	    foreach ($contents as $content) {
	        if ($content) {
		    $i++;
		    $content = '$ ' . $content;
		    $fname = preg_replace('/\.result2$/', "$i.result", $filename);
		    file_put_contents($fname, $content);
		}
	    }
	}

  - product:	/^([-\w+]+)\.eruby/
    toppings:	[ $(original_docdir)/$(1).eruby ]
    method*: |
        if (is_file($topping)) {
	    k_copy($topping, $product);
	}

  - product:	:test
    #ingreds:	[ :test_users_guide, :test_faq, :test_examples ]
    ingreds:	[ users-guide.txt, faq.txt, examples.txt, ../test/test_docs.pl ]
    method*: |
        $testdir = '../test';
	$cwd = k_chdir($testdir);
	k_sys("perl test_docs.pl");
	k_backdir($cwd);

  - product:	:test_users_guide
    ingreds:	[ users-guide.txt, ../test/test_docs.pl ]
    method*: &test_method |
        $name = preg_replace('/:test_/', '', $product);
	$testdir = '../test';
	$cwd = k_chdir($testdir);
	k_sys("perl test_docs.pl $name");
	k_backdir($cwd);

  - product:	:test_faq
    ingreds:	[ faq.txt, ../test/test_docs.pl ]
    method*:	*test_method

  - product:	:test_examples
    ingreds:	[ examples.txt, ../test/test_docs.pl ]
    method*:	*test_method

  - product:	:clean
    method*: |
	k_delete('*.toc.html', 'users-guide.txt', 'faq.txt', 'data');

  - product:	:clear
    ingreds:	[ :clean ]
    method*: |
	k_delete($htmlfiles);
